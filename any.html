const firebaseConfig = {
  apiKey: "AIzaSyAXOfkZH-iisY9RecsDlKFdF2CPQDn5J-Y",
  authDomain: "quessah-c52e7.firebaseapp.com",
  projectId: "quessah-c52e7",
  storageBucket: "quessah-c52e7.appspot.com",
  messagingSenderId: "370785509486",
  appId: "1:370785509486:web:a8970f44852ff24f9dc67f"
};

if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}
const db      = firebase.firestore();
const auth    = firebase.auth();
const storage = firebase.storage();

// ======= Global Variables =======
let wheelCanvas, wheelCtx;
let wheelAngle = Math.PI / (10);
let isSpinning = false;
let currentPrizes = [];

// ======= Initialization =======
document.addEventListener('DOMContentLoaded', async () => {
  await initializeDefaultPrizes();
  currentPrizes = await fetchPrizesFromFirestore();
  initializeWheel();
  loadClaims();
});






function spinWheel() {
  if (isSpinning || currentPrizes.length === 0) return;

  // Ø­Ø¯ ÙŠÙˆÙ…ÙŠ
  const today = new Date().toDateString();
  const userId = getUserId();
  const dailyClaimKey = `dailyClaim_${userId}`;
  const lastClaim = JSON.parse(localStorage.getItem(dailyClaimKey) || '{}');
  if (lastClaim.claimDate && new Date(lastClaim.claimDate).toDateString() === today) {
    alert('Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸ Ø§Ù„ÙŠÙˆÙ…! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ØºØ¯Ø§Ù‹');
    return;
  }

  isSpinning = true;
  const spinBtn = document.getElementById('spin-button');
  spinBtn.disabled = true;
  spinBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¯ÙˆÙŠØ±...';

  // 1) Ù†Ø®ØªØ§Ø± ÙØ§Ø¦Ø² Ø¹Ø´ÙˆØ§Ø¦ÙŠ
  const prizeCount   = currentPrizes.length;
  if (prizeCount < 6) {
    alert('ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø§Ù„Ø¹Ø¬Ù„Ø© Ø¹Ù„Ù‰ 6 Ø¬ÙˆØ§Ø¦Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
    isSpinning = false;
    spinBtn.disabled = false;
    spinBtn.textContent = 'ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø¹Ø¬Ù„Ø©';
    return;
  }
  const winningIndex = Math.floor(Math.random() * prizeCount);
  const winningPrize = currentPrizes[(winningIndex - 2 + prizeCount) % prizeCount];

  // 2) Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©...
  const segmentAngle    = (2 * Math.PI) / prizeCount;
  const rawCenter     = (winningIndex + 0.5) * segmentAngle;
const desiredAngle = (2*Math.PI - rawCenter + wheelAngle % (2*Math.PI)) % (2*Math.PI);
const totalRotation = 4*2*Math.PI + desiredAngle;

  const startAngle      = wheelAngle;
  const duration        = 3000;
  const startTime       = Date.now();

  function animate() {
    const elapsed = Date.now() - startTime;
    const t       = Math.min(elapsed / duration, 1);
    const eased   = 1 - Math.pow(1 - t, 3);

    wheelAngle = startAngle + totalRotation * eased;
    drawWheel();

    if (t < 1) {
      requestAnimationFrame(animate);
    } else {
      setTimeout(async () => {
        // âœ¨ Ù‡Ù†Ø§ Ù†Ø³ØªØ¨Ø¯Ù„ alert Ø¨Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆÙ†Ø®Ø²Ù† Ø§Ù„ÙØ§Ø¦Ø² ÙÙŠ Firestore:

        // 1) Ø®Ø²Ù‘Ù† Ø§Ù„Ù€claim
        const docKey = `dailyClaim_${userId}`;
        const newClaim = {
          userId,
          prizeName: winningPrize.name,
          prizeIcon: winningPrize.icon,
          claimDate: new Date().toISOString()
        };
        await db.collection('claims').doc(docKey).set(newClaim);

        // 2) Ø­Ø¯Ù‘Ø« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª (Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¬Ø§Ù†Ø¨ÙŠ)
        loadClaims();

        // 3) Ø£Ø¸Ù‡Ø± Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©:
        showPrizeModal(winningPrize);

        // 4) Ø£Ø¹Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        isSpinning    = false;
        spinBtn.disabled = false;
        spinBtn.textContent = 'ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø¹Ø¬Ù„Ø©';
      }, 500);
    }
  }

  animate();
}




// Prize Modal Functions
function showPrizeModal(prize) {
    document.getElementById('prize-icon').textContent = prize.icon;
    document.getElementById('prize-name').textContent = prize.name;
    document.getElementById('prize-modal').classList.remove('hidden');
    
    // Store current prize for claiming
    window.currentPrize = prize;
}

function closePrizeModal() {
    document.getElementById('prize-modal').classList.add('hidden');
    window.currentPrize = null;
    closeWheelModal();
}


// Share Functions
function shareWhatsApp() {
    const story = JSON.parse(localStorage.getItem('storyOfTheDay') || '{}');
    const storyUrl = window.location.origin + window.location.pathname.replace('index.html', 'story.html');
    
    const message = `ğŸŒŸ ${story.title || 'Ù‚ØµØ© Ù…Ù„Ù‡Ù…Ø©'}\n\n${(story.content || '').substring(0, 100)}...\n\nØ§Ù‚Ø±Ø£ Ø§Ù„Ù‚ØµØ© ÙƒØ§Ù…Ù„Ø©: ${storyUrl}`;
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    
    window.open(whatsappUrl, '_blank');
}

function shareInstagram() {
    const story = JSON.parse(localStorage.getItem('storyOfTheDay') || '{}');
    const storyUrl = `${window.location.origin}/story.html`;
    
    const message = `ğŸŒŸ ${story.title || 'Ù‚ØµØ© Ù…Ù„Ù‡Ù…Ø©'}\n\n${(story.content || '').substring(0, 150)}...\n\n${storyUrl}`;
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(message).then(() => {
            alert('ØªÙ… Ù†Ø³Ø® Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚ØµØ©! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù„ØµÙ‚Ù‡ ÙÙŠ Ø¥Ù†Ø³ØªØ§Ø¬Ø±Ø§Ù… Stories Ø£Ùˆ Post Ø¬Ø¯ÙŠØ¯.');
        }).catch(() => {
            fallbackCopyToClipboard(message);
        });
    } else {
        fallbackCopyToClipboard(message);
    }
}

function copyToClipboard() {
    const storyUrl = window.location.origin + window.location.pathname.replace('index.html', 'story.html');
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(storyUrl).then(() => {
            alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!');
        }).catch(() => {
            fallbackCopyToClipboard(storyUrl);
        });
    } else {
        fallbackCopyToClipboard(storyUrl);
    }
}

function fallbackCopyToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    try {
        document.execCommand('copy');
        alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!');
    } catch (err) {
        alert('ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠØ±Ø¬Ù‰ Ù†Ø³Ø®Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹: ' + text);
    }
    document.body.removeChild(textArea);
}

// Utility Functions
function getUserId() {
    let userId = localStorage.getItem('userId');
    if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);
    }
    return userId;
}

// Event Listeners for modal close on outside click
document.getElementById('wheel-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeWheelModal();
    }
});

document.getElementById('prize-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePrizeModal();
    }
});

// Keyboard event listeners for accessibility
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (!document.getElementById('wheel-modal').classList.contains('hidden')) {
            closeWheelModal();
        }
        if (!document.getElementById('prize-modal').classList.contains('hidden')) {
            closePrizeModal();
        }
    }
});

// Handle wheel redraw when prizes are updated (for live updates)
window.addEventListener('storage', function(e) {
    if (e.key === 'wheelPrizes') {
        currentPrizes = JSON.parse(e.newValue || '[]');
        if (wheelCtx) {
            drawWheel();
        }
    }
});

// Touch events for mobile wheel interaction (optional enhancement)
if (wheelCanvas) {
    wheelCanvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
    });
}
// Global Variables
 currentPrizes = [];
// ======= Firestore Helpers =======
async function fetchPrizesFromFirestore() {
  try {
    const snap = await db.collection('wheelPrizes').orderBy('name').get();
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  } catch (e) {
    console.error('Error loading prizes:', e);
    return [];
  }
}



async function fetchAllClaims() {
  try {
    const snap = await db.collection('claims').orderBy('claimDate','desc').get();
    return snap.docs.map(d => d.data());
  } catch (e) {
    console.error('Error loading claims:', e);
    return [];
  }
}

async function fetchUserClaimFromFirestore(userId) {
  const docKey = `dailyClaim_${userId}`;
  const doc = await db.collection('claims').doc(docKey).get();
  return doc.exists ? doc.data() : null;
}

// ======= Default Data Seeders =======
async function initializeDefaultPrizes() {
  const snap = await db.collection('wheelPrizes').limit(1).get();
  if (snap.empty) {
    const defaults = [
      { name:'Ø®ØµÙ… 10%', icon:'ğŸ¯' },
      { name:'Ø´Ø­Ù† Ù…Ø¬Ø§Ù†ÙŠ', icon:'ğŸšš' },
      { name:'Ù‡Ø¯ÙŠØ© Ù…Ø¬Ø§Ù†ÙŠØ©', icon:'ğŸ' },
      { name:'Ø®ØµÙ… 20%', icon:'ğŸ’°' },
      { name:'ÙƒÙˆØ¨ÙˆÙ† Ø®Ø§Øµ', icon:'ğŸ«' },
      { name:'Ø¹Ø·Ø± Ù…Ø¬Ø§Ù†ÙŠ', icon:'ğŸŒ¸' }
    ];
    const batch = db.batch();
    defaults.forEach(d => {
      const ref = db.collection('wheelPrizes').doc();
      batch.set(ref, d);
    });
    await batch.commit();
  }
}

// ======= Wheel Initialization & Drawing =======
function initializeWheel() {
  wheelCanvas = document.getElementById('wheel-canvas');
  if (wheelCanvas) {
    wheelCtx = wheelCanvas.getContext('2d');
    drawWheel();
  }
}
function drawWheel() {
  if (!wheelCtx || currentPrizes.length === 0) return;

  // Ø£ÙˆÙ„Ø§Ù‹: Ù†ÙƒØ¨Ø± Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ÙƒØ§Ù†Ú¤Ø§Ø³ (Ù…Ø«Ù„Ø§Ù‹ 600Ã—600)
  wheelCanvas.width  = 600;
  wheelCanvas.height = 600;

  const cx     = wheelCanvas.width  / 2;
  const cy     = wheelCanvas.height / 2;
  // Ù†Ø²ÙˆØ¯ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø­ÙˆØ§Ù Ù„Ù€ 40px Ø¨Ø¯Ù„ 20px
  const outerR = Math.min(cx, cy) - 40;
  const innerR = 60;         // Ù†Ø®Ù„ÙŠ Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ø£ÙƒØ¨Ø± Ø´ÙˆÙŠØ©
  const segA   = (2 * Math.PI) / currentPrizes.length;

  wheelCtx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);

  // Ø£Ù„ÙˆØ§Ù† Ø£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ø§Ù‹ ÙˆØªØ¯Ø±Ø¬Ø§Øª Ø£Ø®Ù
  const baseColors = [
    '#6B5B95', '#feb236', '#d64161', '#ff7b25',
    '#4a90e2', '#50e3c2', '#b8e986', '#bd10e0'
  ];

  currentPrizes.forEach((p, i) => {
    const start = wheelAngle + i * segA;
    const end   = start + segA;
    const color = baseColors[i % baseColors.length];

    // Ø±Ø³Ù… Ø§Ù„Ù‚Ø·Ø§Ø¹ Ù…Ø¹ ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ Ø®ÙÙŠÙ
    const grad = wheelCtx.createRadialGradient(cx, cy, innerR, cx, cy, outerR);
    grad.addColorStop(0, tinycolor(color).lighten(10).toString());
    grad.addColorStop(1, tinycolor(color).darken(10).toString());

    wheelCtx.save();
    wheelCtx.beginPath();
    wheelCtx.moveTo(cx, cy);
    wheelCtx.arc(cx, cy, outerR, start, end);
    wheelCtx.fillStyle   = grad;
    wheelCtx.shadowColor = 'rgba(0,0,0,0.15)';
    wheelCtx.shadowBlur  = 6;
    wheelCtx.fill();

    // Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù‚Ø·Ø§Ø¹
    wheelCtx.strokeStyle = 'rgba(255,255,255,0.9)';
    wheelCtx.lineWidth   = 5;
    wheelCtx.stroke();
    wheelCtx.restore();

    // Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆÙ†Øµ
    wheelCtx.save();
    wheelCtx.translate(cx, cy);
    wheelCtx.rotate(start + segA / 2);

    // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø£ÙƒØ¨Ø±
    wheelCtx.fillStyle = '#fff';
    wheelCtx.font      = '36px serif';
    wheelCtx.textAlign = 'center';
    wheelCtx.fillText(p.icon, outerR * 0.5, 16);

    // Ø§Ø³Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø¨Ø®Ø· Ø£ÙˆØ¶Ø­ ÙˆØ£ÙƒØ¨Ø±
    wheelCtx.font      = 'bold 18px Cairo, Arial';
    wheelCtx.fillText(p.name, outerR * 0.75, 8);

    wheelCtx.restore();
  });

  // Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ø¨ØªØ¯Ø±Ø¬ Ø£Ù†Ø¹Ù…
  wheelCtx.save();
  const hubGrad = wheelCtx.createRadialGradient(cx, cy, 0, cx, cy, innerR);
  hubGrad.addColorStop(0, '#ffffff');
  hubGrad.addColorStop(1, '#f0f0f0');

  wheelCtx.beginPath();
  wheelCtx.arc(cx, cy, innerR, 0, 2 * Math.PI);
  wheelCtx.fillStyle = hubGrad;
  wheelCtx.fill();

  wheelCtx.strokeStyle = '#ccc';
  wheelCtx.lineWidth   = 4;
  wheelCtx.stroke();
  wheelCtx.restore();

  // Ù†Øµ Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ø£ÙƒØ¨Ø±
  wheelCtx.save();
  wheelCtx.fillStyle = '#333';
  wheelCtx.font      = 'bold 20px Arial';
  wheelCtx.textAlign = 'center';
  wheelCtx.fillText('Ø­Ø¸Ù‘Ø§Ù‹ Ø³Ø¹ÙŠØ¯Ø§Ù‹', cx, cy + 8);
  wheelCtx.restore();

  // Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„ÙØ§Ø¦Ø²
  wheelCtx.save();
  wheelCtx.fillStyle = '#e74c3c';
  wheelCtx.beginPath();
  wheelCtx.moveTo(cx - 18, cy - outerR - 15);
  wheelCtx.lineTo(cx + 18, cy - outerR - 15);
  wheelCtx.lineTo(cx, cx - outerR + 25);
  wheelCtx.closePath();
  wheelCtx.fill();
  wheelCtx.restore();
}



// ======= Wheel Modal & Spin =======
async function openWheelModal() {
  const userId = getUserId();
  const today = new Date().toDateString();
  const claim = await fetchUserClaimFromFirestore(userId);
  if (claim?.claimDate && new Date(claim.claimDate).toDateString()===today) {
    document.getElementById('spin-button').style.display='none';
    document.getElementById('daily-limit-message').classList.remove('hidden');
  } else {
    document.getElementById('spin-button').style.display='block';
    document.getElementById('daily-limit-message').classList.add('hidden');
  }
  document.getElementById('wheel-modal').classList.remove('hidden');
  document.body.style.overflow='hidden';
  setTimeout(drawWheel,100);
}
function closeWheelModal() {
  document.getElementById('wheel-modal').classList.add('hidden');
  document.body.style.overflow='';
}



// ======= Prize Modal =======
function showPrizeModal(p) {
  window.currentPrize = p;
  document.getElementById('prize-icon').textContent = p.icon;
  document.getElementById('prize-name').textContent = p.name;
  document.getElementById('prize-modal').classList.remove('hidden');
}

async function claimPrize() {
  if (!window.currentPrize) return;
  const userId = getUserId();
  const docKey = `dailyClaim_${userId}`;
  const newClaim = {
    userId,
    prizeName: window.currentPrize.name,
    prizeIcon: window.currentPrize.icon,
    claimDate: new Date().toISOString()
  };
  // save in Firestore
  await db.collection('claims').doc(docKey).set(newClaim);
  alert(`ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¬Ø§Ø¦Ø²ØªÙƒ: ${newClaim.prizeName}`);
  closePrizeModal();
  closeWheelModal();
}

// ======= Claims Dashboard =======
async function loadClaims() {
  const container = document.getElementById('claims-list');
  if (!container) return;
  container.innerHTML = '<div class="text-gray-500 text-center py-8">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
  const claims = await fetchAllClaims();
  if (claims.length===0) {
    container.innerHTML = '<div class="text-gray-500 text-center py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø·Ø§Ù„Ø¨Ø§Øª</div>';
    return;
  }
  container.innerHTML = claims.map(c=>`
    <div class="bg-gray-50 p-4 rounded-lg mb-2">
      <div class="flex justify-between">
        <div>
          <div class="font-medium">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${c.userId}</div>
          <div class="text-sm">Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©: ${c.prizeName}</div>
          <div class="text-xs text-gray-500">${new Date(c.claimDate).toLocaleString('ar-SA')}</div>
        </div>
        <button class="bg-red-500 px-2 rounded" onclick="clearUserClaim('${c.userId}')">Ù…Ø³Ø­</button>
      </div>
    </div>
  `).join('');
}

async function clearUserClaim(userId) {
  if (!confirm('Ù…Ø³Ø­ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø©ØŸ')) return;
  await db.collection('claims').doc(`dailyClaim_${userId}`).delete();
  loadClaims();
}

async function clearAllClaims() {
  if (!confirm('Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§ØªØŸ')) return;
  const snap = await db.collection('claims').get();
  const batch = db.batch();
  snap.forEach(d=> batch.delete(d.ref));
  await batch.commit();
  loadClaims();
}

// ======= Utility =======
function getUserId() {
  let uid = localStorage.getItem('userId');
  if (!uid) {
    uid = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2,9);
    localStorage.setItem('userId', uid);
  }
  return uid;
}

// ======= Event Listeners for Modals =======
document.getElementById('wheel-modal').addEventListener('click', e=> {
  if (e.target===e.currentTarget) closeWheelModal();
});
document.getElementById('prize-modal').addEventListener('click', e=> {
  if (e.target===e.currentTarget) closePrizeModal();
});
document.addEventListener('keydown', e=> {
  if (e.key==='Escape') { closeWheelModal(); closePrizeModal(); }
});
