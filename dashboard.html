<!DOCTYPE html>
<html lang="ar" dir="rtl">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­ØªÙˆÙ‰ Ø¹Ø§Ù„Ù… Ù‚ØµØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase (compat) -->
    <script
      src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script
      src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script
      src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script
      src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

    <link rel="stylesheet" href="./output.css" />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#303590",
              accent: "#565BB6",
              "dark-accent": "#041710",
            },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap");

      body {
        font-family: "Cairo", sans-serif;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .animate-spin {
        animation: spin 0.7s linear infinite;
      }
    </style>
  </head>

  <body class="bg-gray-50 min-h-screen">
    <header class="bg-primary text-white py-6 shadow-lg">
      <div class="container mx-auto px-4">
        <div class="flex justify-between items-center">
          <h1 class="text-3xl font-bold">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
          <a href="index.html"
            class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors">
            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹
          </a>
        </div>
      </div>
    </header>

    <div class="container mx-auto px-4 py-8">
      <div class="mb-8">
        <div class="border-b border-gray-200">
          <nav class="-mb-px flex">
            <button onclick="showTab('story')" id="story-tab"
              class="tab-button active mr-8 py-2 px-1 border-b-2 font-medium text-sm">
              Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚ØµØµ
            </button>
            <button onclick="showTab('prizes')" id="prizes-tab"
              class="tab-button mr-8 py-2 px-1 border-b-2 font-medium text-sm">
              Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²
            </button>
            <button onclick="showTab('claims')" id="claims-tab"
              class="tab-button py-2 px-1 border-b-2 font-medium text-sm">
              Ø³Ø¬Ù„ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª
            </button>
          </nav>
        </div>
      </div>

      <!-- Story Management -->
      <div id="story-content" class="tab-content">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
          <h2 class="text-2xl font-bold text-primary mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚ØµØµ</h2>
          <form id="story-form" class="space-y-6" data-editing-id>
            <div>
              <label for="story-title-input"
                class="block text-sm font-medium text-gray-700 mb-2">Ø¹Ù†ÙˆØ§Ù†
                Ø§Ù„Ù‚ØµØ©</label>
              <input type="text" id="story-title-input" name="title"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚ØµØ©" required />
            </div>

            <div>
              <label for="story-image-file"
                class="block text-sm font-medium text-gray-700 mb-2">ØµÙˆØ±Ø©
                Ø§Ù„Ù‚ØµØ©</label>
              <div class="flex items-center space-x-4">
                <label for="story-image-file"
                  class="cursor-pointer bg-accent hover:bg-accent/90 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                  ğŸ“· Ø§Ø®ØªØ± ØµÙˆØ±Ø©
                </label>
                <input type="file" id="story-image-file" accept="image/*"
                  class="hidden" />
                <span id="story-image-filename"
                  class="text-gray-600 truncate">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©</span>
              </div>
              <div id="story-image-preview" class="mt-4 hidden">
                <img src alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©"
                  class="mx-auto rounded-lg max-h-48 shadow-md" />
              </div>
            </div>

            <div>
              <label for="story-content-input"
                class="block text-sm font-medium text-gray-700 mb-2">Ù…Ø­ØªÙˆÙ‰
                Ø§Ù„Ù‚ØµØ©</label>
              <textarea id="story-content-input" name="content" rows="6"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚ØµØ© Ù‡Ù†Ø§..." required></textarea>
            </div>

            <div class="flex gap-4">
              <button id="submitStoryBtn" type="submit"
                class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg transition-colors flex-1 text-center">
                <span id="submitStoryText">Ù†Ø´Ø± Ø§Ù„Ù‚ØµØ©</span>
                <span id="submitStoryLoader"
                  class="hidden ml-2 animate-spin">â³</span>
              </button>
              <button type="button" onclick="clearStoryForm()"
                class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">
                Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
              </button>
            </div>
          </form>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚ØµØµ</h3>
          <div id="stories-list" class="space-y-4 text-right"></div>
        </div>
      </div>

      <!-- Prizes Management -->
      <div id="prizes-content" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
          <h2 class="text-2xl font-bold text-primary mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø¬ÙˆØ§Ø¦Ø²
            Ø§Ù„Ø¹Ø¬Ù„Ø©</h2>
          <form id="prize-form" class="space-y-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label for="prize-name-input"
                  class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø³Ù…
                  Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©</label>
                <input type="text" id="prize-name-input" name="name"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                  placeholder="Ù…Ø«Ø§Ù„: Ø®ØµÙ… 20%">
              </div>

              <div>
                <label for="prize-icon-input"
                  class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø±Ù…Ø²
                  (emoji)</label>
                <input type="text" id="prize-icon-input" name="icon"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                  placeholder="ğŸ">
              </div>
              <div>
                <label for="prize-weight-input"
                  class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„ÙˆØ²Ù†
                  (prob. weight %)</label>
                <input type="number" id="prize-weight-input" name="weight"
                  min="1" max="100" step="1"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  placeholder="Ù…Ø«Ø§Ù„: 20">
              </div>

              <div>
                <label for="prize-message-input"
                  class="block text-sm font-medium text-gray-700 mb-2">Ù†Øµ
                  Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©</label>
                <textarea id="prize-message-input" name="message" rows="2"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                  placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¨Ø±ÙˆÙˆÙˆÙƒ! Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆØ¯ XYZ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰â€¦"
                  required></textarea>
              </div>

              <div class="flex items-end">
                <button type="submit"
                  class="w-full bg-accent hover:bg-accent/90 text-white px-6 py-2 rounded-lg transition-colors">Ø¥Ø¶Ø§ÙØ©
                  Ø¬Ø§Ø¦Ø²Ø©</button>
              </div>
            </div>
          </form>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</h3>
          <div id="prizes-list" class="space-y-2"></div>
        </div>
      </div>

      <!-- Claims Log -->
      <div id="claims-content" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-primary">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª
              Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
            <button onclick="clearAllClaims()"
              class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">Ù…Ø³Ø­
              Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
          </div>

          <div id="claims-list" class="space-y-4"></div>
        </div>
      </div>
    </div>

    <!-- participants modal -->
    <div id="participants-modal"
      class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
      <div
        class="bg-white dark:bg-gray-900 dark:text-white rounded-2xl max-w-3xl w-full mx-4 p-6 relative">
        <button onclick="closeParticipantsModal()"
          class="absolute left-4 top-4 text-gray-500 hover:text-gray-700">âœ–</button>
        <h3 class="text-xl font-semibold text-right mb-4">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</h3>

        <div class="mb-4 flex gap-2 items-center">
          <input id="participants-search" type="search"
            placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..."
            class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary" />
          <div id="participants-loading"
            class="text-sm text-gray-500 hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„... <span
              class="inline-block animate-spin">â³</span></div>
        </div>

        <div id="participants-list" class="max-h-72 overflow-y-auto space-y-2">
          <div class="text-gray-500 text-center py-8">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>
        </div>

        <div class="mt-4 flex justify-end">
          <button onclick="closeParticipantsModal()"
            class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-lg">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>

    <div id="message-container" class="fixed top-4 right-4 z-50"></div>

    <!-- main script -->
    <script>
      // Firebase init
      const firebaseConfig = {
        apiKey: "AIzaSyAXOfkZH-iisY9RecsDlKFdF2CPQDn5J-Y",
        authDomain: "quessah-c52e7.firebaseapp.com",
        projectId: "quessah-c52e7",
        storageBucket: "quessah-c52e7.appspot.com",
        messagingSenderId: "370785509486",
        appId: "1:370785509486:web:a8970f44852ff24f9dc67f"
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const storage = firebase.storage();

      // small helpers for escaping
      function escapeHtml(text) {
        if (!text && text !== 0) return "";
        return String(text)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
      function escapeJs(text) {
        if (!text && text !== 0) return "";
        return String(text).replace(/'/g, "\\'").replace(/\n/g, "\\n");
      }

      // showTab
      function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('active', 'text-primary', 'border-primary');
          btn.classList.add('text-gray-500', 'hover:text-gray-700', 'border-transparent');
        });
        document.getElementById(`${tabName}-content`).classList.remove('hidden');
        const active = document.getElementById(`${tabName}-tab`);
        if (active) {
          active.classList.add('active', 'text-primary', 'border-primary');
          active.classList.remove('text-gray-500', 'hover:text-gray-700', 'border-transparent');
        }
      }

      // cloudinary helper (unchanged)
      const CLOUDINARY_CLOUD_NAME = 'dxp3nhgpm';
      const CLOUDINARY_UPLOAD_PRESET = 'unsigned_preset';
      async function uploadImageToCloudinary(file) {
        const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        const res = await fetch(url, { method: 'POST', body: formData });
        const data = await res.json();
        if (!res.ok || !data.secure_url) {
          console.error('Cloudinary error', data);
          throw new Error(data.error?.message || 'Upload failed');
        }
        return data.secure_url;
      }

      // small toast
      function showMessage(msg, type = 'info') {
        const container = document.getElementById('message-container');
        const div = document.createElement('div');
        const bg = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        div.className = `${bg} text-white px-4 py-2 rounded-lg mb-2 shadow-lg`;
        div.textContent = msg;
        container.appendChild(div);
        setTimeout(() => div.remove(), 3000);
      }

      /* =========================
         Stories management (kept same)
         ========================= */
      async function loadStories() {
        const c = document.getElementById('stories-list');
        c.innerHTML = `<div class="text-gray-500 text-center py-6">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>`;
        try {
          const snap = await db.collection('stories').orderBy('createdAt', 'desc').get();
          if (snap.empty) {
            c.innerHTML = `<div class="text-gray-500 text-center py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ØµØµ</div>`;
            return;
          }
          c.innerHTML = snap.docs.map(doc => {
            const s = { id: doc.id, ...doc.data() };
            const hasImage = s.image && typeof s.image === 'string' && s.image.trim() !== '' && s.image.trim() !== 'null' && !s.image.includes('dashboard.html') && !s.image.startsWith('file:///');
            return `
              <div class="bg-gray-50 p-4 rounded-lg flex justify-between items-start">
                <div class="flex-shrink-0 mr-4">
                  ${hasImage ? `<img src="${s.image}" alt="${s.title}" class="w-24 h-24 object-cover rounded-lg shadow-sm">` : ''}
                </div>
                <div class="flex-1 text-right">
                  <h4 class="font-semibold mb-1">${escapeHtml(s.title)}</h4>
                  <p class="text-sm text-gray-700 p-2">${escapeHtml(s.content)}</p>
                </div>
                <div class="flex flex-col gap-2 ml-4">
                  <button onclick="editStory('${s.id}')" class="px-3 py-1 bg-accent text-white rounded">ØªØ¹Ø¯ÙŠÙ„</button>
                  <button onclick="deleteStory('${s.id}')" class="px-3 py-1 bg-red-500 text-white rounded">Ø­Ø°Ù</button>
                </div>
              </div>`;
          }).join('');
        } catch (e) {
          console.error(e);
          c.innerHTML = `<div class="text-red-500 text-center py-6">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù‚ØµØµ</div>`;
        }
      }

      async function editStory(id) {
        const doc = await db.collection('stories').doc(id).get();
        if (!doc.exists) return showMessage('Ø§Ù„Ù‚ØµØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
        const s = { id: doc.id, ...doc.data() };
        document.getElementById('story-title-input').value = s.title;
        document.getElementById('story-content-input').value = s.content;
        const prev = document.getElementById('story-image-preview');
        prev.querySelector('img').src = s.image || '';
        prev.classList.remove('hidden');
        document.getElementById('story-image-filename').textContent = 'â€“';
        document.getElementById('story-form').dataset.editingId = id;
      }

      async function deleteStory(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) return;
        await db.collection('stories').doc(id).delete();
        showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚ØµØ©', 'success');
        loadStories();
      }

      function clearStoryForm() {
        const f = document.getElementById('story-form');
        f.reset();
        f.dataset.editingId = '';
        document.getElementById('story-image-preview').classList.add('hidden');
        document.getElementById('story-image-filename').textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©';
      }

      document.getElementById('story-image-file').addEventListener('change', e => {
        const file = e.target.files[0];
        const name = document.getElementById('story-image-filename');
        const prev = document.getElementById('story-image-preview');
        const img = prev.querySelector('img');
        if (file) {
          name.textContent = file.name;
          const r = new FileReader();
          r.onload = () => {
            img.src = r.result;
            prev.classList.remove('hidden');
          };
          r.readAsDataURL(file);
        } else {
          name.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©';
          prev.classList.add('hidden');
        }
      });

      document.getElementById('story-form').addEventListener('submit', async e => {
        e.preventDefault();
        const btn = document.getElementById('submitStoryBtn');
        const txt = document.getElementById('submitStoryText');
        const load = document.getElementById('submitStoryLoader');
        btn.disabled = true; txt.classList.add('hidden'); load.classList.remove('hidden');

        const form = e.target;
        const id = form.dataset.editingId || null;
        const title = form.title.value.trim();
        const content = form.content.value.trim();

        let imageUrl = '';
        const file = form.elements['story-image-file'].files[0];
        try {
          if (file) imageUrl = await uploadImageToCloudinary(file);
          else imageUrl = document.querySelector('#story-image-preview img').src || '';

          if (id) {
            await db.collection('stories').doc(id).update({ title, content, image: imageUrl });
            showMessage('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ØµØ©', 'success');
          } else {
            await db.collection('stories').add({ title, content, image: imageUrl, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ØµØ©', 'success');
          }
          clearStoryForm();
          loadStories();
        } catch (err) {
          console.error(err);
          showMessage('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù‚ØµØ©', 'error');
        } finally {
          btn.disabled = false; txt.classList.remove('hidden'); load.classList.add('hidden');
        }
      });

      /* =========================
         Prizes management (kept)
         ========================= */
      async function loadPrizes() {
        const container = document.getElementById('prizes-list');
        container.innerHTML = '<div class="text-gray-500 text-center py-8">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
        try {
          const snap = await db.collection('wheelPrizes').orderBy('name').get();
          const prizes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          if (prizes.length === 0) {
            container.innerHTML = '<div class="text-gray-500 text-center py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬ÙˆØ§Ø¦Ø²</div>';
            return;
          }
          container.innerHTML = prizes.map(p => `
            <div class="bg-gray-50 p-4 rounded-lg mb-2">
              <div class="flex items-start gap-4">
                <span class="text-2xl">${p.icon}</span>
                <div class="flex-1">
                  <div class="font-medium text-lg">${escapeHtml(p.name)}</div>
                  <div class="text-sm text-gray-600 mb-2">${escapeHtml(p.message || '')}</div>
                  <div class="text-xs text-gray-500">Ø§Ù„ÙˆØ²Ù†: ${p.weight || 1}%</div>
                </div>
                <div class="flex flex-col gap-2">
                  <button onclick="editPrize('${p.id}')" class="bg-accent px-3 py-1 rounded text-sm text-white">ØªØ¹Ø¯ÙŠÙ„</button>
                  <button onclick="deletePrize('${p.id}')" class="bg-red-500 px-3 py-1 rounded text-sm text-white">Ø­Ø°Ù</button>
                </div>
              </div>
            </div>
          `).join('');
        } catch (e) {
          console.error(e);
          container.innerHTML = '<div class="text-red-500 text-center py-8">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>';
        }
      }

      async function editPrize(id) {
        const doc = await db.collection('wheelPrizes').doc(id).get();
        if (!doc.exists) return showMessage('Ù„Ù… Ø£Ø¬Ø¯ Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©', 'error');
        const p = { id: doc.id, ...doc.data() };
        document.getElementById('prize-name-input').value = p.name;
        document.getElementById('prize-icon-input').value = p.icon;
        document.getElementById('prize-message-input').value = p.message || '';
        document.getElementById('prize-weight-input').value = p.weight || '';
        document.getElementById('prize-form').dataset.editingId = id;
      }

      async function deletePrize(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
        await db.collection('wheelPrizes').doc(id).delete();
        showMessage('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'success');
        loadPrizes();
      }

      document.getElementById('prize-form').addEventListener('submit', async e => {
        e.preventDefault();
        const form = e.target;
        const name = form.name.value.trim();
        const icon = form.icon.value.trim() || 'ğŸ';
        const message = form.message.value.trim();
        const weight = parseInt(form.weight.value, 10) || 1;
        if (!name || !message) return showMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© ÙˆØ±Ø³Ø§Ù„ØªÙ‡Ø§', 'error');

        const editingId = form.dataset.editingId;
        try {
          if (editingId) {
            await db.collection('wheelPrizes').doc(editingId).update({ name, icon, message, weight });
            delete form.dataset.editingId;
          } else {
            await db.collection('wheelPrizes').add({ name, icon, message, weight });
          }
          showMessage('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
          form.reset();
          loadPrizes();
        } catch (err) {
          console.error(err);
          showMessage('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©', 'error');
        }
      });

      async function initializeDefaultPrizes() {
        const snap = await db.collection('wheelPrizes').limit(1).get();
        if (snap.empty) {
          const defaults = [
            { name: 'Ù…Ù†Ø§Ø¯ÙŠÙ„ Ù‚ØµØ© Ù‡Ø¯ÙŠØ©', icon: 'ğŸ§»', message: 'Ù…Ø¨Ø±ÙˆÙˆÙˆÙƒ! Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙˆØ¯: GIFT5 Ùˆ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…Ù†Ø§Ø¯ÙŠÙ„ Ù‚ØµØ© Ù…Ø¬Ø§Ù†Ù‹Ø§ Ù…Ø¹ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù….', weight: 5 },
            { name: 'Ø®ØµÙ… 50% Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù…', icon: 'ğŸ‰', message: 'Ù…Ø¨Ø±ÙˆÙˆÙˆÙƒ! Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙˆØ¯: D50 Ùˆ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®ØµÙ… 50Ùª Ø­ØªÙ‰ 100 Ø±ÙŠØ§Ù„ Ù…Ø¹ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù….', weight: 5 },
            { name: 'Ø®ØµÙ… 25% Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù…', icon: 'ğŸ’µ', message: 'Ù…Ø¨Ø±ÙˆÙˆÙˆÙƒ! Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙˆØ¯: D25 Ùˆ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®ØµÙ… 25Ùª Ø­ØªÙ‰ 100 Ø±ÙŠØ§Ù„ Ù…Ø¹ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù….', weight: 35 },
            { name: 'ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù…', icon: 'ğŸšš', message: 'Ù…Ø¨Ø±ÙˆÙˆÙˆÙƒ! Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙˆØ¯: SHIP Ùˆ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø´Ø­Ù† Ù…Ø¬Ø§Ù†ÙŠ Ù…Ø¹ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù….', weight: 30 },
            { name: 'Ø®ØµÙ… 10 Ø±ÙŠØ§Ù„ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù…', icon: 'ğŸ”–', message: 'Ø­Ø¸Ùƒ Ø·ÙŠØ¨! Ø®ØµÙ… 10 Ø±ÙŠØ§Ù„ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù…ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆØ¯: D10', weight: 20 },
            { name: 'Ø·Ù„Ø¨Ùƒ Ø¹Ù„ÙŠÙ†Ø§ (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 300 Ø±ÙŠØ§Ù„)', icon: 'ğŸ', message: 'Ù…Ø¨Ø±ÙˆÙˆÙˆÙˆÙƒ!!! Ø·Ù„Ø¨Ùƒ Ø¹Ù„ÙŠÙ†Ø§ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆØ¯: FREE300', weight: 5 }
          ];
          const batch = db.batch();
          defaults.forEach(d => {
            const ref = db.collection('wheelPrizes').doc();
            batch.set(ref, d);
          });
          await batch.commit();
        }
      }

      /* =========================
         Claims management
         ========================= */
      async function fetchAllClaims() {
        try {
          const snap = await db.collection('claims').orderBy('claimDate', 'desc').get();
          return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        } catch (e) {
          console.error('Error loading claims:', e);
          return [];
        }
      }

      async function loadClaims() {
        const container = document.getElementById('claims-list');
        container.innerHTML = '<div class="text-gray-500 text-center py-8">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
        try {
          const claims = await fetchAllClaims();
          if (!claims || claims.length === 0) {
            container.innerHTML = '<div class="text-gray-500 text-center py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø·Ø§Ù„Ø¨Ø§Øª</div>';
            return;
          }
          container.innerHTML = claims.map(c => {
            const claimDate = c.claimDate ? new Date(c.claimDate).toLocaleDateString('ar-SA') : '';
            // display userId from doc data (some claims may have synthetic id in doc id)
            const userId = c.userId || (c.id ? c.id.replace(/^dailyClaim_/, '') : '');
            return `
              <div class="bg-gray-50 p-4 rounded-lg mb-2">
                <div class="flex justify-between items-center">
                  <div>
                    <div class="font-semibold">ğŸ‘¤ ${escapeHtml(userId)}</div>
                    <div>ğŸ ${escapeHtml(c.prizeName || '')}</div>
                    <div class="text-sm text-gray-600">${escapeHtml(claimDate)}</div>
                  </div>
                  <div class="flex items-center gap-2">
                    <button onclick="openParticipantsModal('${escapeJs(userId)}')" title="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†" class="bg-sky-500 hover:bg-sky-600 text-white px-3 py-1 rounded text-sm">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
                    <button onclick="clearUserClaim('${escapeJs(userId)}')" class="bg-red-500 px-3 py-1 rounded text-sm text-white">Ù…Ø³Ø­</button>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        } catch (e) {
          console.error(e);
          container.innerHTML = '<div class="text-red-500 text-center py-8">Ø®Ø·Ø£</div>';
        }
      }

      async function clearUserClaim(userId) {
        if (!confirm('Ù…Ø³Ø­ØŸ')) return;
        try {
          await db.collection('claims').doc(`dailyClaim_${userId}`).delete();
        } catch (e) {
          console.warn('Failed to delete claim', e);
        }
        showMessage('ØªÙ… Ø§Ù„Ù…Ø³Ø­', 'success');
        loadClaims();
      }

      async function clearAllClaims() {
        if (!confirm('Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ')) return;
        try {
          const snap = await db.collection('claims').get();
          const batch = db.batch();
          snap.forEach(d => batch.delete(d.ref));
          await batch.commit();
        } catch (e) {
          console.warn('Failed to clear all claims', e);
        }
        showMessage('ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„', 'success');
        loadClaims();
      }

      /* =========================
         Participants modal logic (fixed)
         ========================= */

      let participantsCache = []; // cached deduped array

      // normalize phone helper
      function normalizePhoneForQuery(phone) {
        if (!phone && phone !== 0) return '';
        return String(phone).replace(/[^0-9\+]/g, '').trim();
      }

      // dedupe helper (keeps first seen by phone or id)
      function dedupeParticipants(arr) {
        if (!Array.isArray(arr)) return [];
        const byPhone = new Map();
        const byId = new Map();
        const out = [];
        for (const p of arr) {
          const id = p && p.id ? String(p.id) : null;
          const phone = normalizePhoneForQuery(p && p.phone ? p.phone : '');
          if (phone) {
            if (byPhone.has(phone)) continue;
            byPhone.set(phone, p);
            out.push(p);
            continue;
          }
          if (id) {
            if (byId.has(id)) continue;
            byId.set(id, p);
            out.push(p);
            continue;
          }
          // fallback: avoid object duplicates
          if (!out.includes(p)) out.push(p);
        }
        return out;
      }

      // render list (single point)
      function renderParticipantsList(arr) {
        const list = document.getElementById('participants-list');
        if (!list) return;
        if (!arr || arr.length === 0) {
          list.innerHTML = '<div class="text-gray-500 text-center py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
          return;
        }
        // build html once
        list.innerHTML = arr.map(p => `
          <div class="p-3 border rounded-lg bg-gray-50 dark:bg-gray-800">
            <div class="flex justify-between items-center">
              <div class="text-right">
                <div class="font-semibold">${escapeHtml(p.name || 'â€”')}</div>
                <div class="text-sm text-gray-600">ğŸ“ ${escapeHtml(p.phone || 'â€”')}</div>
                <div class="text-sm text-gray-600">âœ‰ï¸ ${escapeHtml(p.email || 'â€”')}</div>
              </div>
              <div class="text-left text-xs text-gray-400">${escapeHtml(p.id || '')}</div>
            </div>
          </div>
        `).join('');
      }

      /**
       * openParticipantsModal(forUserId)
       * - tries to read claims/dailyClaim_<forUserId>
       * - tries to extract phone/participantId and fetch matching wheelParticipants
       * - if no link found, shows all participants (deduped) so admin can search
       */
      async function openParticipantsModal(forUserId = null) {
        const modal = document.getElementById('participants-modal');
        const list = document.getElementById('participants-list');
        const loading = document.getElementById('participants-loading');
        const search = document.getElementById('participants-search');
        if (!modal || !list) return;

        list.innerHTML = '';
        search.value = '';
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        loading.classList.remove('hidden');

        try {
          // try get claim doc
          let claimDoc = null;
          if (forUserId) {
            try {
              const key = `dailyClaim_${forUserId}`;
              const doc = await db.collection('claims').doc(key).get();
              if (doc.exists) claimDoc = { id: doc.id, ...doc.data() };
            } catch (err) {
              console.warn('Failed to fetch claim doc', err);
            }
          }

          // if we have claimDoc, attempt to extract phone(s) and participantId
          if (claimDoc) {
            // try various possible keys placed earlier in app
            const phoneKeys = ['participantPhone', 'phone', 'userPhone', 'phoneNumber', 'phone_number'];
            let phoneCandidate = null;
            for (const k of phoneKeys) {
              if (claimDoc[k]) { phoneCandidate = normalizePhoneForQuery(claimDoc[k]); break; }
            }

            // participant id candidates
            const idKeys = ['participantId', 'participant_id', 'participantDocId', 'userId'];
            let participantIdCandidate = null;
            for (const k of idKeys) {
              if (claimDoc[k]) { participantIdCandidate = String(claimDoc[k]); break; }
            }

            // prefer phone query
            if (phoneCandidate) {
              const snap = await db.collection('wheelParticipants').where('phone', '==', phoneCandidate).get();
              const results = snap.docs.map(d => ({ id: d.id, ...d.data() }));
              console.log('[participants] fetched by phone count=', results.length, 'phone=', phoneCandidate);
              const deduped = dedupeParticipants(results);
              console.log('[participants] deduped=', deduped.length);
              participantsCache = deduped.slice();
              renderParticipantsList(deduped);
              return;
            }

            // else try participant doc id
            if (participantIdCandidate) {
              try {
                const doc = await db.collection('wheelParticipants').doc(participantIdCandidate).get();
                if (doc.exists) {
                  const p = { id: doc.id, ...doc.data() };
                  participantsCache = [p];
                  renderParticipantsList([p]);
                  console.log('[participants] fetched by id', p.id);
                  return;
                } else {
                  console.warn('participant id candidate not found as doc id:', participantIdCandidate);
                }
              } catch (err) {
                console.warn('error fetching participant by id', err);
              }
            }

            // If claim exists but no link fields found â€” show message and fallback to full list
            list.innerHTML = `
              <div class="text-gray-600 text-right p-4">
                <div class="font-semibold mb-2">Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© (ID: ${escapeHtml(claimDoc.id)}) ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‡Ø§ØªÙ/Ù…Ø¹Ø±Ù‘Ù Ù…Ø±ØªØ¨Ø·Ø©.</div>
                <div class="text-sm">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ø¯Ù†Ø§Ù‡ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ù„ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ phone Ø£Ùˆ participantId.</div>
              </div>
            `;
            // fallback: fetch all participants so admin can search
          }

          // if we reach here: fetch all participants (if not cached)
          let raw;
          if (!participantsCache || participantsCache.length === 0) {
            const snap = await db.collection('wheelParticipants').get();
            raw = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            console.log('[participants] fetched all count=', raw.length);
            const dedupedAll = dedupeParticipants(raw);
            console.log('[participants] deduped=', dedupedAll.length);
            participantsCache = dedupedAll.slice();
          }

          renderParticipantsList(participantsCache);
        } catch (err) {
          console.error('Failed loading participants (linked mode)', err);
          list.innerHTML = '<div class="text-red-500 text-center py-6">ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</div>';
        } finally {
          loading.classList.add('hidden');
        }

        // attach search handler
        search.oninput = () => {
          const q = (search.value || '').trim().toLowerCase();
          const filtered = (participantsCache || []).filter(p => {
            const name = (p.name || '').toString().toLowerCase();
            const phone = (p.phone || '').toString().toLowerCase();
            const email = (p.email || '').toString().toLowerCase();
            return name.includes(q) || phone.includes(q) || email.includes(q);
          });
          renderParticipantsList(filtered);
        };
      }

      function closeParticipantsModal() {
        const modal = document.getElementById('participants-modal');
        if (!modal) return;
        modal.classList.add('hidden');
        document.body.style.overflow = '';
      }
      document.addEventListener('keydown', function (e) { if (e.key === 'Escape') closeParticipantsModal(); });

      // click outside to close
      document.addEventListener('click', function (e) {
        const modal = document.getElementById('participants-modal');
        if (!modal || modal.classList.contains('hidden')) return;
        if (!e.target.closest('#participants-modal .rounded-2xl') && e.target.id === 'participants-modal') closeParticipantsModal();
      });

      /* =========================
         Initialization
         ========================= */
      document.addEventListener('DOMContentLoaded', async () => {
        // initial UI
        showTab('story');

        // load data
        await initializeDefaultPrizes();
        loadPrizes();
        loadStories();
        loadClaims();
      });
    </script>
  </body>
</html>
